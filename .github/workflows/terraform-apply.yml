name: Terraform Infrastructure Deployment

on:
  push:
    branches: [ main ]

env:
  BUCKET_NAME: terraform-state-lorrylach-2024  # â¬…ï¸ MÃªme nom qu'avant
  AWS_REGION: us-east-1

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 : BOOTSTRAP - PrÃ©pare l'infrastructure de base
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  bootstrap:
    name: ğŸš€ Bootstrap AWS Backend
    runs-on: ubuntu-latest
    outputs:
      bucket_exists: ${{ steps.check_bucket.outputs.exists }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Check if S3 bucket exists
        id: check_bucket
        run: |
          echo "VÃ©rification du bucket ${{ env.BUCKET_NAME }}..."
          if aws s3 ls "s3://${{ env.BUCKET_NAME }}" 2>&1 | grep -q 'NoSuchBucket\|An error occurred'; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Bucket n'existe pas - crÃ©ation nÃ©cessaire"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Bucket existe dÃ©jÃ "
          fi

      - name: ğŸª£ Create S3 bucket
        if: steps.check_bucket.outputs.exists == 'false'
        run: |
          echo "CrÃ©ation du bucket ${{ env.BUCKET_NAME }}..."
          aws s3 mb "s3://${{ env.BUCKET_NAME }}" --region ${{ env.AWS_REGION }}
          
          echo "Activation du versioning..."
          aws s3api put-bucket-versioning \
            --bucket "${{ env.BUCKET_NAME }}" \
            --versioning-configuration Status=Enabled
          
          echo "Activation du chiffrement..."
          aws s3api put-bucket-encryption \
            --bucket "${{ env.BUCKET_NAME }}" \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }]
            }'
          
          echo "Blocage de l'accÃ¨s public..."
          aws s3api put-public-access-block \
            --bucket "${{ env.BUCKET_NAME }}" \
            --public-access-block-configuration \
            "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          
          echo "âœ… Bucket crÃ©Ã© et configurÃ© avec succÃ¨s"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 : TERRAFORM - DÃ©ploie l'infrastructure
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  terraform:
    name: ğŸ—ï¸ Terraform Deployment
    runs-on: ubuntu-latest
    needs: bootstrap  # â¬…ï¸ Attend que le bootstrap soit terminÃ©
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0  # â¬…ï¸ Ajustez la version si nÃ©cessaire

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ¯ Terraform Init
        run: |
          echo "Initialisation de Terraform..."
          terraform init
          echo "âœ… Terraform initialisÃ©"

      - name: ğŸ¨ Terraform Format Check
        run: terraform fmt -check
        continue-on-error: true  # Ne bloque pas le workflow si le format n'est pas parfait

      - name: âœ… Terraform Validate
        run: |
          echo "Validation de la configuration..."
          terraform validate
          echo "âœ… Configuration valide"

      - name: ğŸ“‹ Terraform Plan
        run: |
          echo "GÃ©nÃ©ration du plan d'exÃ©cution..."
          terraform plan -out=tfplan
          echo "âœ… Plan gÃ©nÃ©rÃ©"

      - name: ğŸš€ Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Application du plan Terraform..."
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure dÃ©ployÃ©e"

      - name: ğŸ“¤ Output Terraform Results
        if: always()
        run: |
          echo "Affichage des outputs..."
          terraform output || echo "Aucun output disponible"