name: Terraform Destroy Infrastructure

on:
  workflow_dispatch:  
   

env:
  AWS_REGION: us-east-1
  BUCKET_NAME: terraform-state-lorrylach-2025
  TF_VERSION: 1.6.0

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 : VALIDATION DE LA CONFIRMATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: âœ‹ Validate Destruction Request
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›‘ Check Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "destroy" ]; then
            echo "âŒ ERREUR: Vous devez taper 'destroy' pour confirmer"
            echo "Vous avez tapÃ©: '${{ github.event.inputs.confirm }}'"
            exit 1
          fi
          echo "âœ… Confirmation reÃ§ue - destruction autorisÃ©e"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 : DESTRUCTION DE L'INFRASTRUCTURE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  destroy:
    name: ğŸ’¥ Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Verify S3 Backend
        run: |
          echo "VÃ©rification du backend S3..."
          if aws s3api head-bucket --bucket "${{ env.BUCKET_NAME }}" 2>/dev/null; then
            echo "âœ… Backend S3 accessible"
          else
            echo "âš ï¸ Le bucket S3 n'existe pas - l'Ã©tat Terraform est peut-Ãªtre dÃ©jÃ  supprimÃ©"
            exit 1
          fi

      - name: ğŸ¯ Terraform Init
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Initialisation de Terraform"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform init -input=false
          echo "âœ… Terraform initialisÃ©"

      - name: ğŸ“‹ List Current Resources
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Ressources actuellement dÃ©ployÃ©es:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform state list || echo "Aucune ressource trouvÃ©e"

      - name: ğŸ“Š Terraform Plan Destroy
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "GÃ©nÃ©ration du plan de destruction"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform plan -destroy -input=false -out=destroy.tfplan
          echo "âœ… Plan de destruction gÃ©nÃ©rÃ©"

      - name: ğŸ“„ Show Destroy Plan
        run: |
          echo "AperÃ§u des ressources Ã  dÃ©truire:"
          terraform show -no-color destroy.tfplan | head -n 50

      - name: â¸ï¸ Wait Before Destruction
        run: |
          echo "â³ Attente de 10 secondes avant destruction..."
          echo "   (Temps de rÃ©flexion pour annuler si nÃ©cessaire)"
          sleep 10

      - name: ğŸ’¥ Terraform Destroy
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”¥ DESTRUCTION DE L'INFRASTRUCTURE ğŸ”¥"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform destroy -auto-approve -input=false
          echo "âœ… Infrastructure dÃ©truite avec succÃ¨s"

      - name: ğŸ§¹ Verify Destruction
        run: |
          echo "VÃ©rification de la destruction..."
          RESOURCES=$(terraform state list | wc -l)
          if [ "$RESOURCES" -eq 0 ]; then
            echo "âœ… Toutes les ressources ont Ã©tÃ© dÃ©truites"
          else
            echo "âš ï¸ Attention: $RESOURCES ressource(s) restante(s)"
            terraform state list
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 : NETTOYAGE DU BUCKET S3 (Optionnel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cleanup:
    name: ğŸ§¹ Cleanup S3 Backend (Optional)
    runs-on: ubuntu-latest
    needs: destroy
    if: success()
    
    steps:
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ—‘ï¸ Clean S3 State Files
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Nettoyage des fichiers d'Ã©tat S3"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Lister les fichiers
          echo "ğŸ“‹ Fichiers dans le bucket:"
          aws s3 ls s3://${{ env.BUCKET_NAME }}/project/ --recursive
          
          # Demande de confirmation pour supprimer les fichiers d'Ã©tat
          echo ""
          echo "âš ï¸  ATTENTION: Voulez-vous supprimer les fichiers d'Ã©tat?"
          echo "   Les fichiers d'Ã©tat contiennent l'historique de votre infrastructure"
          echo ""
          echo "Pour supprimer automatiquement, dÃ©commentez les lignes ci-dessous"
          
          # DÃ©commentez ces lignes pour supprimer automatiquement
          # aws s3 rm s3://${{ env.BUCKET_NAME }}/project/ --recursive
          # echo "âœ… Fichiers d'Ã©tat supprimÃ©s"

      - name: ğŸª£ Delete S3 Bucket (Optional)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Suppression du bucket S3"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "âš ï¸  Pour supprimer le bucket, dÃ©commentez les lignes ci-dessous"
          
          # DÃ©commentez ces lignes pour supprimer le bucket
          # aws s3 rb s3://${{ env.BUCKET_NAME }} --force
          # echo "âœ… Bucket S3 supprimÃ©"
          
          echo "â„¹ï¸  Le bucket S3 est conservÃ© pour rÃ©fÃ©rence"
          echo "   Vous pouvez le supprimer manuellement depuis la console AWS"